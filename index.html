<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>OpenPaths - VZM Walking/Cycling with AQI Overlay</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  body { margin: 0; padding: 0; }
  #map { width: 100%; height: 100vh; }
  .controls {
    position: absolute; top: 10px; left: 10px; background: white; padding: 6px; z-index: 1000;
    border-radius: 6px; box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  }
</style>
</head>
<body>

<div class="controls">
  <label for="mode">Mode: </label>
  <select id="mode">
    <option value="foot">Walk</option>
    <option value="bike">Cycle</option>
  </select>
</div>

<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// Initialize map centered on Vizianagaram
var map = L.map('map').setView([18.1067, 83.3956], 13);

// Add basemap
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
}).addTo(map);

let startMarker = null;
let endMarker = null;
let routeLayer = null;

// Sample AQI data (lat, lon, AQI value)
let aqiData = [
  { lat: 18.106, lon: 83.395, aqi: 40 },
  { lat: 18.11, lon: 83.40, aqi: 90 },
  { lat: 18.115, lon: 83.39, aqi: 150 },
  { lat: 18.12, lon: 83.38, aqi: 200 }
];

// Function to get AQI color
function getAQIColor(aqi) {
  if (aqi <= 50) return "green";
  if (aqi <= 100) return "yellow";
  if (aqi <= 150) return "orange";
  if (aqi <= 200) return "red";
  return "purple";
}

// Add AQI markers
aqiData.forEach(p => {
  L.circleMarker([p.lat, p.lon], {
    radius: 6,
    color: getAQIColor(p.aqi),
    fillOpacity: 0.8
  }).bindPopup(`AQI: ${p.aqi}`).addTo(map);
});

// Handle clicks to select start/end
map.on('click', function(e) {
  if (!startMarker) {
    startMarker = L.marker(e.latlng).addTo(map).bindPopup("Start").openPopup();
  } else if (!endMarker) {
    endMarker = L.marker(e.latlng).addTo(map).bindPopup("End").openPopup();
    drawRoute();
  } else {
    // Reset
    map.removeLayer(startMarker);
    map.removeLayer(endMarker);
    if (routeLayer) map.removeLayer(routeLayer);
    startMarker = L.marker(e.latlng).addTo(map).bindPopup("Start").openPopup();
    endMarker = null;
  }
});

// Draw route with color-coded segments based on AQI exposure
function drawRoute() {
  if (!startMarker || !endMarker) return;
  let mode = document.getElementById("mode").value;
  let profile = mode === "bike" ? "cycling" : "foot";

  // OSRM Routing API (public demo server)
  let url = `https://router.project-osrm.org/route/v1/${profile}/${startMarker.getLatLng().lng},${startMarker.getLatLng().lat};${endMarker.getLatLng().lng},${endMarker.getLatLng().lat}?geometries=geojson`;

  fetch(url)
    .then(res => res.json())
    .then(data => {
      if (routeLayer) map.removeLayer(routeLayer);
      let coords = data.routes[0].geometry.coordinates;

      // Convert to Leaflet latLngs
      let latLngs = coords.map(c => [c[1], c[0]]);

      // For now: color segments by nearest AQI point
      let segments = [];
      for (let i = 0; i < latLngs.length - 1; i++) {
        let midLat = (latLngs[i][0] + latLngs[i+1][0]) / 2;
        let midLng = (latLngs[i][1] + latLngs[i+1][1]) / 2;
        let nearest = aqiData.reduce((a, b) => {
          let distA = Math.hypot(a.lat - midLat, a.lon - midLng);
          let distB = Math.hypot(b.lat - midLat, b.lon - midLng);
          return distA < distB ? a : b;
        });
        let color = getAQIColor(nearest.aqi);
        segments.push(L.polyline([latLngs[i], latLngs[i+1]], {color: color, weight: 5, opacity: 0.8}));
      }
      routeLayer = L.layerGroup(segments).addTo(map);
    });
}

document.getElementById("mode").addEventListener("change", drawRoute);

</script>

</body>
</html>
